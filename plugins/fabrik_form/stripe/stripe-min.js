/*! Fabrik */

define(["jquery","fab/fabrik"],function(n,r){"use strict";return new Class({options:{publicKey:"",item:"",zipCode:!0,allowRememberMe:!1,email:"",name:"",panelLabel:"",useCheckout:!0,billingAddress:!1,couponElement:"",renderOrder:""},initialize:function(t){var e=this;if(this.options=n.extend(this.options,t),this.form=r.getBlock("form_"+this.options.formid),r.FabrikStripeForm=null,r.FabrikStripeFormSubmitting=!1,""!==this.options.couponElement){this.couponElement=e.form.formElements.get(this.options.couponElement);var i=this.couponElement.getBlurEvent();e.form.dispatchEvent("",this.options.couponElement,i,function(t){e.getCoupon(t)})}if(this.options.useCheckout)this.handler=StripeCheckout.configure({key:this.options.publicKey,image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(t,e){r.FabrikStripeForm.form.adopt(new Element("input",{name:"stripe_token_id",value:t.id,type:"hidden"})),r.FabrikStripeForm.form.adopt(new Element("input",{name:"stripe_token_email",value:t.email,type:"hidden"})),r.FabrikStripeForm.form.adopt(new Element("input",{name:"stripe_token_opts",value:JSON.stringify(e),type:"hidden"})),r.FabrikStripeForm.mockSubmit()},closed:function(){r.FabrikStripeFormSubmitting=!0}}),r.addEvent("fabrik.form.submit.start",function(t,e,i){(this.options.ccOnFree||0!=this.options.amount)&&(void 0!==r.FabrikStripeForm&&!0===r.FabrikStripeFormSubmitting&&0!==n("input[name=stripe_token_id]").length||(r.FabrikStripeForm=t,this.handler.open({name:this.options.name,description:this.options.item,amount:this.options.amount,zipCode:this.options.zipCode,allowRememberMe:this.options.allowRememberMe,email:this.options.email,panelLabel:this.options.panelLabel,billingAddress:this.options.billingAddress}),e.preventDefault(),t.result=!1))}.bind(this)),window.addEventListener("popstate",function(){this.handler.close()});else if(this.options.updateCheckout){var o=this.form.form.getElement(".fabrikStripeChange");"null"!==typeOf(o)&&(this.handler=StripeCheckout.configure({key:this.options.publicKey,image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(t,e){r.FabrikStripeForm.form.adopt(new Element("input",{name:"stripe_token_id",value:t.id,type:"hidden"})),r.FabrikStripeForm.form.adopt(new Element("input",{name:"stripe_token_email",value:t.email,type:"hidden"})),r.FabrikStripeForm.form.adopt(new Element("input",{name:"stripe_token_opts",value:JSON.stringify(e),type:"hidden"})),n(".fabrikStripeLast4").text(Joomla.JText._("PLG_FORM_STRIPE_CUSTOMERS_UPDATE_CC_UPDATED"))}}),o.addEvent("click",function(t){t.preventDefault(),r.FabrikStripeForm=this.form,this.handler.open({name:this.options.name,description:this.options.item,zipCode:this.options.zipCode,allowRememberMe:this.options.allowRememberMe,email:this.options.email,panelLabel:this.options.panelLabel,billingAddress:this.options.billingAddress})}.bind(this)))}},getCoupon:function(t){r.loader.start("form_"+this.options.formid,Joomla.JText._("PLG_FORM_AUTOFILL_SEARCHING"));var e=this.couponElement.getValue(),i=this.options.formid,o=this;n.ajax({url:"index.php",method:"post",dataType:"json",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"stripe",method:"ajax_getCoupon",amount:this.options.origAmount,g:"form",v:e,formid:i,renderOrder:this.options.renderOrder}}).always(function(){r.loader.stop("form_"+o.options.formid)}).fail(function(t,e,i){window.alert(e)}).done(function(t){o.updateForm(t)})},updateForm:function(t){this.options.amount=t.stripe_amount,n(".fabrikStripePrice").html(t.display_amount),n(".fabrikStripeCouponText").html(t.msg)}})});